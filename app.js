const express = require("express");
const bodyParser = require("body-parser");
const path = require("path");
const mysql = require('mysql2'); 
const { authenticateUser } = require(__dirname + "/db_query/auth.js");
const { getBooks } = require(__dirname + "/db_query/books.js"); 
const db = require(__dirname + "/db_query/db.js"); 
const pool = require(__dirname + "/db_query/pool.js"); 
const app = express();
const bcrypt = require("bcryptjs"); 
const { getAuthorByBook } = require(__dirname + "/db_query/author.js");
const { getBookSeriesByAuthor } = require(__dirname + "/db_query/book_series.js");
const session = require('express-session');
// Middleware
app.use(session({
    secret: 'mysecretkey',
    resave: false,
    saveUninitialized: false,
    cookie: {
        secure: false, // ƒê·∫∑t th√†nh true n·∫øu d√πng HTTPS
        httpOnly: true, 
        maxAge: 24 * 60 * 60 * 1000,
        sameSite: 'lax'
    }
}));
app.use((req, res, next) => {
    console.log('Session data:', req.session); // Log session m·ªói request
    next();
});
app.use(bodyParser.urlencoded({ extended: true }));
app.use(express.static(path.join(__dirname, "static")));
app.use(express.json());
function checkAuth(req, res, next) {
    if (!req.session.user_id) {
        console.log('Unauthorized access - No session user_id'); // Debug
        return res.status(401).json({ success: false, message: "B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p." });
    }
    next();
}
// Trang login
app.get("/", (req, res) => {
    res.sendFile(path.join(__dirname, "templates", "login.html"));
});
app.get("/api/session", (req, res) => {
    res.json({
        user_id: req.session.user_id || null,
    });
});
// Route ƒë·ªÉ l·∫•y d·ªØ li·ªáu s√°ch
app.get("/books", (req, res) => {
    getBooks((err, books) => {
        if (err) {
            res.status(500).json({ error: "L·ªói khi l·∫•y d·ªØ li·ªáu s√°ch" });
        } else {
            res.json(books);
        }
    });
});

// Trang ch√≠nh
app.get("/index.html",checkAuth, (req, res) => {
    res.sendFile(path.join(__dirname, "templates", "index.html"));
    
});
// API tr·∫£ v·ªÅ JSON
app.get("/book/:id", checkAuth, async(req, res) => {
    console.log("Route /book/:id ƒë∆∞·ª£c g·ªçi v·ªõi ID:", req.params.id); // ‚úÖ Th√™m log n√†y

    const bookId = req.params.id;
    const query = "SELECT * FROM all_book WHERE book_id = ?";

    try {
        const [results] = await db.execute(query, [bookId]);

        if (results.length > 0) {
            return res.json(results[0]); // ‚úÖ Tr·∫£ v·ªÅ d·ªØ li·ªáu t√°c gi·∫£ ƒë√∫ng
        } else {
            return res.status(404).json({ error: "Kh√¥ng t√¨m th·∫•y t√°c gi·∫£" });
        }
    } catch (err) {
        return res.status(500).json({ error: "L·ªói khi truy v·∫•n d·ªØ li·ªáu t√°c gi·∫£" });
    }
});

// Route hi·ªÉn th·ªã file HTML
app.get("/book-detail.html",checkAuth, (req, res) => {
    res.sendFile(path.join(__dirname, "templates", "book-detail.html"));
});
// T√°c gi·∫£
app.get("/author.html",checkAuth, (req, res) => {
    res.sendFile(path.join(__dirname, "templates", "author.html"));
});

app.get("/author/:id", checkAuth, async (req, res) => {
    const authorId = req.params.id;
    const query = "SELECT * FROM all_authors WHERE author_id = ?";

    try {
        // S·ª≠ d·ª•ng db.execute() ho·∫∑c db.query() v·ªõi promise
        const [results] = await db.execute(query, [authorId]);

        if (results.length > 0) {
            return res.json(results[0]); // ‚úÖ Tr·∫£ v·ªÅ d·ªØ li·ªáu t√°c gi·∫£ ƒë√∫ng
        } else {
            return res.status(404).json({ error: "Kh√¥ng t√¨m th·∫•y t√°c gi·∫£" });
        }
    } catch (err) {
        return res.status(500).json({ error: "L·ªói khi truy v·∫•n d·ªØ li·ªáu t√°c gi·∫£" });
    }
});
app.get("/check-author", async (req, res) => {
    const {name} = req.query;
    const [rows] = await db.query('SELECT Author_ID, author FROM all_authors WHERE author LIKE ?', [`%${name}%`]);
    res.json(rows);
})
// Ch·ªß ƒë·ªÅ 
app.get("/subject.html",checkAuth, (req, res) => {
    res.sendFile(path.join(__dirname, "templates", "subject.html"));
});
app.get("/subject/:id",checkAuth, async(req, res) => {
    const subjectId = req.params.id;

    const query = "SELECT * FROM all_book_subjects WHERE subject_id = ?"; 

    try {
        // S·ª≠ d·ª•ng db.execute() ho·∫∑c db.query() v·ªõi promise
        const [results] = await db.execute(query, [subjectId]);

        if (results.length > 0) {
            return res.json(results[0]); // ‚úÖ Tr·∫£ v·ªÅ d·ªØ li·ªáu t√°c gi·∫£ ƒë√∫ng
        } else {
            return res.status(404).json({ error: "Kh√¥ng t√¨m th·∫•y t√°c gi·∫£" });
        }
    } catch (err) {
        return res.status(500).json({ error: "L·ªói khi truy v·∫•n d·ªØ li·ªáu t√°c gi·∫£" });
    }
});
app.get("/check-subject", async (req, res) => {
    const {name} = req.query;
    const [rows] = await db.query('SELECT subject_id, \`book subject\` FROM all_book_subjects WHERE \`book subject\` LIKE ?', [`%${name}%`]);
    res.json(rows);
})
// Nh√† xu·∫•t b·∫£n
app.get("/book_publisher.html",checkAuth, (req, res) => {
    res.sendFile(path.join(__dirname, "templates", "book_publisher.html"));
});
app.get("/book_publisher/:id",checkAuth, async(req, res) => {
    const publisherId = req.params.id;

    const query = "SELECT * FROM all_book_publishers WHERE publisher_id = ?"; 

    try {
        // S·ª≠ d·ª•ng db.execute() ho·∫∑c db.query() v·ªõi promise
        const [results] = await db.execute(query, [publisherId]);

        if (results.length > 0) {
            return res.json(results[0]); // ‚úÖ Tr·∫£ v·ªÅ d·ªØ li·ªáu t√°c gi·∫£ ƒë√∫ng
        } else {
            return res.status(404).json({ error: "Kh√¥ng t√¨m th·∫•y t√°c gi·∫£" });
        }
    } catch (err) {
        return res.status(500).json({ error: "L·ªói khi truy v·∫•n d·ªØ li·ªáu t√°c gi·∫£" });
    }
});
app.get('/check-publisher', async (req, res) => {
    const { name } = req.query;
    const [rows] = await db.query('SELECT publisher_id, book_publisher FROM all_book_publishers WHERE book_publisher LIKE ?', [`%${name}%`]);
    res.json(rows);
  });
// Series
app.get("/book-series/:bookSeriesId",checkAuth, (req, res) => {
    const bookSeriesId = req.params.bookSeriesId;
    console.log("üìå bookSeriesId nh·∫≠n ƒë∆∞·ª£c:", bookSeriesId); // Ki·ªÉm tra ID

    getBookSeriesByAuthor(bookSeriesId, (err, bookSeries) => {
        if (err) {
            console.error("‚ùå L·ªói truy v·∫•n:", err);
            return res.status(500).json({ error: "L·ªói l·∫•y lo·∫°t s√°ch" });
        }
        console.log("‚úÖ D·ªØ li·ªáu tr·∫£ v·ªÅ:", bookSeries);
        res.json({ book_series: bookSeries });
    });
});
app.get("/book-series-detail/:id",checkAuth, async(req, res) => {
    const authorId = req.params.id;

    const query = "SELECT * FROM all_book_series WHERE book_series_id = ?"; // üî• Truy v·∫•n theo author_id

    try {
        // S·ª≠ d·ª•ng db.execute() ho·∫∑c db.query() v·ªõi promise
        const [results] = await db.execute(query, [authorId]);

        if (results.length > 0) {
            return res.json(results[0]); // ‚úÖ Tr·∫£ v·ªÅ d·ªØ li·ªáu t√°c gi·∫£ ƒë√∫ng
        } else {
            return res.status(404).json({ error: "Kh√¥ng t√¨m th·∫•y t√°c gi·∫£" });
        }
    } catch (err) {
        return res.status(500).json({ error: "L·ªói khi truy v·∫•n d·ªØ li·ªáu t√°c gi·∫£" });
    }
});
app.get("/book_series.html",checkAuth, (req, res) => {
    res.sendFile(path.join(__dirname, "templates", "book_series.html"));
});
// Ph·∫ßn login user
app.post('/login',(req, res) => {
    const { email, password } = req.body;

    if (!email || !password) {
        return res.status(400).json({ success: false, message: "Email v√† m·∫≠t kh·∫©u kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!" });
    }

    pool.getConnection((err, connection) => {
        if (err) {
            console.error("L·ªói k·∫øt n·ªëi database:", err);
            return res.status(500).json({ success: false, message: "L·ªói m√°y ch·ªß!" });
        }

        const query = `
            SELECT role, User_ID AS id, Full_Name AS name, Email, Sinh_vien, Giao_vien, Password 
            FROM user WHERE Email = ?
            UNION
            SELECT role, EmployeeID AS id, Full_Name AS name, Email, Null as Sinh_vien, Null as Giao_vien, Password 
            FROM employee WHERE Email = ?
        `;

        connection.query(query, [email, email], (err, results) => {
            connection.release();

            if (err) {
                console.error("L·ªói truy v·∫•n:", err);
                return res.status(500).json({ success: false, message: "L·ªói m√°y ch·ªß!" });
            }

            if (results.length === 0) {
                return res.status(404).json({ success: false, message: "Email kh√¥ng t·ªìn t·∫°i trong h·ªá th·ªëng!" });
            }

            const user = results[0];

            bcrypt.compare(password, user.Password, (err, isMatch) => {
                if (err) {
                    console.error("L·ªói ki·ªÉm tra m·∫≠t kh·∫©u:", err);
                    return res.status(500).json({ success: false, message: "L·ªói m√°y ch·ªß!" });
                }

                if (!isMatch) {
                    return res.status(401).json({ success: false, message: "M·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c!" });
                }

                // Thi·∫øt l·∫≠p session cho ng∆∞·ªùi d√πng
                req.session.user_id = user.id;
                req.session.role = user.role;
                req.session.email = user.email;
                // X√°c ƒë·ªãnh n·∫øu l√† Sinh vi√™n hay Gi√°o vi√™n
                let userType = 'user'; // M·∫∑c ƒë·ªãnh l√† user
                if (user.Sinh_vien === 1) {
                    userType = 'sinhvien';
                } else if (user.Giao_vien === 1) {
                    userType = 'giaovien';
                } else {
                    // Ch·ªâ c√≥ trong b·∫£ng employee
                    if (user.role === 'admin') {
                        userType = 'admin';
                    } else if (user.role === 'employee') {
                        userType = 'employee';
                    }
                }
                req.session.save(err => {
                    if (err) {
                      console.error('L·ªói l∆∞u session:', err);
                      return res.status(500).json({ success: false, message: "L·ªói server" });
                    }
                    res.json({
                        success: true,
                        message: "ƒêƒÉng nh·∫≠p th√†nh c√¥ng!",
                        role: user.role,
                        userId: user.id,
                        email: user.email,
                        fullName: user.name,
                        userType: userType 
                    });
                });
            });
        });
    });
});


app.post('/check-unique', (req, res) => {
    const { email, phone } = req.body;

    pool.getConnection((err, connection) => {
        if (err) {
            console.error('Error getting connection:', err.message);
            return res.status(500).json({ success: false, message: 'L·ªói server: ' + err.message });
        }

        // Ki·ªÉm tra email
        connection.query('SELECT * FROM user WHERE Email = ?', [email], (err, emailRows) => {
            if (err) {
                connection.release();
                console.error('Error checking email:', err.message);
                return res.status(500).json({ success: false, message: 'L·ªói server: ' + err.message });
            }

            if (emailRows.length > 0) {
                connection.release();
                return res.json({ success: false, message: 'email_exists' });
            }

            // Ki·ªÉm tra phone
            connection.query('SELECT * FROM user WHERE Phone_number = ?', [phone], (err, phoneRows) => {
                if (err) {
                    connection.release();
                    console.error('Error checking phone:', err.message);
                    return res.status(500).json({ success: false, message: 'L·ªói server: ' + err.message });
                }

                if (phoneRows.length > 0) {
                    connection.release();
                    return res.json({ success: false, message: 'phone_exists' });
                }

                connection.release();
                res.json({ success: true });
            });
        });
    });
});

// API ƒë·ªÉ x·ª≠ l√Ω ƒëƒÉng k√Ω
app.post('/register', (req, res) => {
    const { userID, fullName, email, password, phone, sinhvien, giaovien } = req.body;
    console.log(req.body);

    if (!password) {
        return res.status(400).json({ success: false, message: "M·∫≠t kh·∫©u kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!" });
    }

    pool.getConnection((err, connection) => {
        if (err) {
            console.error("Error getting connection:", err.message);
            return res.status(500).json({ success: false, message: "L·ªói server: " + err.message });
        }

        // Ki·ªÉm tra User_ID c√≥ b·ªã tr√πng kh√¥ng
        connection.query('SELECT * FROM user WHERE User_ID = ?', [userID], (err, userIdRows) => {
            if (err) {
                connection.release();
                console.error("Error checking UserID:", err.message);
                return res.status(500).json({ success: false, message: "L·ªói server: " + err.message });
            }

            if (userIdRows.length > 0) {
                connection.release();
                return res.json({ success: false, message: "MSSV/MSGV ƒë√£ t·ªìn t·∫°i!" });
            }

            if (sinhvien === 1 && giaovien === 1) {
                connection.release();
                return res.json({ success: false, message: "Ch·ªâ ƒë∆∞·ª£c ch·ªçn m·ªôt vai tr√≤: Sinh vi√™n ho·∫∑c Gi√°o vi√™n!" });
            }
            if (sinhvien === 0 && giaovien === 0) {
                connection.release();
                return res.json({ success: false, message: "Ph·∫£i ch·ªçn m·ªôt vai tr√≤: Sinh vi√™n ho·∫∑c Gi√°o vi√™n!" });
            }

            // M√£ h√≥a m·∫≠t kh·∫©u
            const saltRounds = 10;
            bcrypt.hash(password, saltRounds, (err, hashedPassword) => {
                if (err || !hashedPassword) {
                    connection.release();
                    console.error("L·ªói khi m√£ h√≥a m·∫≠t kh·∫©u:", err ? err.message : "M·∫≠t kh·∫©u kh√¥ng h·ª£p l·ªá");
                    return res.status(500).json({ success: false, message: "L·ªói khi m√£ h√≥a m·∫≠t kh·∫©u!" });
                }

                // Th√™m ng∆∞·ªùi d√πng m·ªõi v√†o database
                const insertQuery = `
                    INSERT INTO user (User_ID, Full_Name, Email, Password, Phone_number, Sinh_vien, Giao_vien)
                    VALUES (?, ?, ?, ?, ?, ?, ?)
                `;

                const values = [userID, fullName, email, hashedPassword, phone, sinhvien, giaovien];

                connection.query(insertQuery, values, (err, result) => {
                    connection.release();
                    if (err) {
                        console.error("L·ªói khi ch√®n ng∆∞·ªùi d√πng:", err.message);
                        return res.status(500).json({ success: false, message: "ƒêƒÉng k√Ω th·∫•t b·∫°i!" });
                    }

                    return res.json({ success: true, message: "ƒêƒÉng k√Ω th√†nh c√¥ng!" });
                });
            });
        });
    });
});

// L·∫•y th√¥ng tin ng∆∞·ªùi d√πng
app.get("/current-user", checkAuth, async (req, res) => {
    const userId = req.session.user_id;

    if (!userId) {
        return res.status(401).json({ error: "Ch∆∞a ƒëƒÉng nh·∫≠p" });
    }

    try {
        // ∆Øu ti√™n l·∫•y t·ª´ b·∫£ng employee
        const employeeQuery = "SELECT Full_Name, email, Phone_number, role FROM employee WHERE EmployeeID = ?";
        const [empResults] = await db.query(employeeQuery, [userId]);

        if (empResults.length > 0) {
            return res.json(empResults[0]);  // Tr·∫£ v·ªÅ d·ªØ li·ªáu t·ª´ b·∫£ng employee n·∫øu c√≥
        } else {
            // N·∫øu kh√¥ng c√≥ trong employee th√¨ l·∫•y t·ª´ user
            const userQuery = "SELECT Full_Name, email, Phone_number, role FROM user WHERE User_ID = ?";
            const [userResults] = await db.query(userQuery, [userId]);

            if (userResults.length > 0) {
                return res.json(userResults[0]);
            } else {
                return res.status(404).json({ error: "Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng" });
            }
        }
    } catch (err) {
        console.error("L·ªói khi truy v·∫•n d·ªØ li·ªáu ng∆∞·ªùi d√πng:", err);
        return res.status(500).json({ error: "L·ªói m√°y ch·ªß" });
    }
});

app.get("/login", (req, res) => {
    res.sendFile(__dirname + "/templates/login.html");
});
app.get("/user_profile",checkAuth, (req, res) => {
    if (!req.session.user_id) {
        return res.redirect("/login"); // chuy·ªÉn h∆∞·ªõng n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p
    }

    res.sendFile(__dirname + "/templates/user_profile.html");
});
app.put("/update-user",checkAuth, async (req, res) => {
    const { Full_Name, email, Phone_number } = req.body;
    const userId = req.session.user_id;

    if (!userId) {
        return res.status(401).json({ error: "Ch∆∞a ƒëƒÉng nh·∫≠p" });
    }

    const query = `UPDATE user SET Full_Name = ?, Email = ?, Phone_number = ? WHERE User_ID = ?`;

    try {
        // Th·ª±c thi c√¢u l·ªánh UPDATE
        const [result] = await db.query(query, [Full_Name, email, Phone_number, userId]);

        // Ki·ªÉm tra k·∫øt qu·∫£ c·∫≠p nh·∫≠t
        if (result.affectedRows === 0) {
            return res.status(404).json({ error: "Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng ƒë·ªÉ c·∫≠p nh·∫≠t" });
        }

        return res.json({ message: "C·∫≠p nh·∫≠t th√†nh c√¥ng" });
    } catch (err) {
        console.error("L·ªói khi c·∫≠p nh·∫≠t:", err);
        return res.status(500).json({ error: "L·ªói m√°y ch·ªß" });
    }
});

// Thay ƒë·ªïi m·∫≠t kh·∫©u
app.put('/change-password', async (req, res) => {
    const userId = req.session.user_id;
    const { current_password, new_password } = req.body;

    if (!userId) {
        return res.status(401).json({ success: false, error: "B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p." });
    }

    if (!current_password || !new_password) {
        return res.status(400).json({ success: false, error: "Thi·∫øu th√¥ng tin." });
    }

    try {
        // L·∫•y hash password t·ª´ DB
        const sqlGet = "SELECT password FROM user WHERE User_ID = ?";
        const [results] = await db.query(sqlGet, [userId]);

        if (results.length === 0) {
            return res.status(404).json({ success: false, error: "Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng." });
        }

        const hashedPassword = results[0].password;

        // So s√°nh password nh·∫≠p v·ªõi hash
        const match = await bcrypt.compare(current_password, hashedPassword);
        if (!match) {
            return res.status(403).json({ success: false, error: "M·∫≠t kh·∫©u hi·ªán t·∫°i kh√¥ng ƒë√∫ng." });
        }

        // Hash m·∫≠t kh·∫©u m·ªõi
        const newHashedPassword = await bcrypt.hash(new_password, 10);

        // C·∫≠p nh·∫≠t m·∫≠t kh·∫©u
        const sqlUpdate = "UPDATE user SET password = ? WHERE User_ID = ?";
        await db.query(sqlUpdate, [newHashedPassword, userId]);

        return res.json({ success: true, message: "ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!" });
    } catch (err) {
        console.error("L·ªói khi x·ª≠ l√Ω y√™u c·∫ßu ƒë·ªïi m·∫≠t kh·∫©u:", err);
        return res.status(500).json({ success: false, error: "L·ªói m√°y ch·ªß khi ƒë·ªïi m·∫≠t kh·∫©u." });
    }
});

app.get('/change_password.html',checkAuth, (req, res) => {
    res.sendFile(__dirname + "/templates/change_password.html");
  });
// M∆∞·ª£n s√°ch
app.post("/borrow", async (req, res) => {
    const userId = req.session.user_id;
    const { bookId } = req.body;

    if (!userId) {
        return res.status(401).json({ error: "B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ m∆∞·ª£n s√°ch." });
    }

    if (!bookId) {
        return res.status(400).json({ error: "Thi·∫øu m√£ s√°ch." });
    }

    const borrowDate = new Date();
    const returnDate = new Date(); // gi·∫£ s·ª≠ tr·∫£ sau 14 ng√†y
    returnDate.setDate(returnDate.getDate() + 14);

    const query = `
        INSERT INTO borrow (User_ID, Book_ID, Borrow_Date, Return_Date, Status)
        VALUES (?, ?, ?, ?, 'ƒêang m∆∞·ª£n')
    `;

    try {
        await db.query(query, [userId, bookId, borrowDate, returnDate]);
        res.json({ success: true, message: "M∆∞·ª£n s√°ch th√†nh c√¥ng!" });
    } catch (err) {
        console.error("L·ªói khi m∆∞·ª£n s√°ch:", err);
        res.status(500).json({ error: "Kh√¥ng th·ªÉ m∆∞·ª£n s√°ch." });
    }
});

// L·∫•y danh s√°ch s√°ch ƒë√£ m∆∞·ª£n
app.get('/borrowed-books', async (req, res) => {
    const userId = req.session.user_id;
    if (!userId) return res.status(401).json({ message: "Ch∆∞a ƒëƒÉng nh·∫≠p" });

    const query = `
      SELECT 
      b.Borrow_ID, b.Borrow_Date, b.Return_Date, b.Status,
      ab.book, ab.author
      FROM borrow b
      JOIN all_book ab ON b.Book_ID = ab.book_id
      WHERE b.User_ID = ?
    `;
  
    try {
        const results = await db.query(query, [userId]);
        res.json(results);
    } catch (err) {
        return res.status(500).json({ message: "L·ªói server", error: err });
    }
});
// Tra sach
app.delete("/return-book/:id", async (req, res) => {
    const borrowId = req.params.id;
    const sql = `
      UPDATE borrow
      SET Status = 'ƒê√£ tr·∫£', Actual_Return_Date = CURDATE()
      WHERE Borrow_ID = ?
    `;

    try {
        await db.query(sql, [borrowId]);
        res.json({ message: "Tr·∫£ s√°ch th√†nh c√¥ng!" });
    } catch (err) {
        console.error("L·ªói khi tr·∫£ s√°ch:", err);
        return res.status(500).json({ error: "L·ªói server khi tr·∫£ s√°ch" });
    }
});

// Th√™m s√°ch
app.post('/add-book', async (req, res) => {
    const {
      book, author, book_subject, book_publisher_name,
      image, pub_date, earliest_pub_date, language, isbn
    } = req.body;

    if (!author || !book_subject || !book_publisher_name) {
      return res.status(400).send('Thi·∫øu th√¥ng tin t√°c gi·∫£, ch·ªß ƒë·ªÅ ho·∫∑c nh√† xu·∫•t b·∫£n');
    }

    const trimLower = str => str ? str.trim().toLowerCase() : '';

    const insertOrGetId = async (table, column, value) => {
      const querySelect = `SELECT ${table}_id AS id FROM ${table} WHERE ${column} = ?`;
      const results = await db.query(querySelect, [value]);

      if (results.length > 0) {
        return results[0].id;
      }

      const queryInsert = `INSERT INTO ${table} (${column}) VALUES (?)`;
      const result = await db.query(queryInsert, [value]);
      return result.insertId;
    };

    try {
      const author_id = await insertOrGetId('all_authors', 'author', trimLower(author));
      const subject_id = await insertOrGetId('all_book_subjects', 'book_subject', trimLower(book_subject));
      const publisher_id = await insertOrGetId('all_book_publishers', 'book_publisher', trimLower(book_publisher_name));

      const insertBookQuery = `
        INSERT INTO all_book (
          book, author_id, subject_id, image, \`publication date\`,
          \`earliest publication date\`, language, isbn, publisher_id
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
      `;

      await db.query(insertBookQuery, [
        book, author_id, subject_id, image,
        pub_date, earliest_pub_date, language, isbn, publisher_id
      ]);

      res.redirect('/add-book.html');
    } catch (err) {
      console.error('L·ªói th√™m s√°ch:', err);
      return res.status(500).send('Th√™m s√°ch th·∫•t b·∫°i');
    }
});


  
// S·ª≠a s√°ch
app.post('/edit-book', async (req, res) => {
    const { book, author, book_subject, book_publisher, image, pub_date, language, earliest_pub_date, ISBN, book_id } = req.body;

    const query = `
      UPDATE all_book
      SET book = ?, author = ?, \`book subject\` = ?, \`book publisher\` = ?, image = ?, \`publication date\` = ?, language = ?, \`earliest publication date\` = ?, ISBN = ?
      WHERE book_id = ?
    `;

    try {
        await db.query(query, [book, author, book_subject, book_publisher, image, pub_date, language, earliest_pub_date, ISBN, book_id]);
        res.redirect('/edit-book.html');
    } catch (err) {
        console.error('L·ªói khi c·∫≠p nh·∫≠t s√°ch:', err);
        return res.status(500).send('C·∫≠p nh·∫≠t s√°ch th·∫•t b·∫°i.');
    }
});

app.delete('/delete-book/:id', async (req, res) => {
    const bookId = req.params.id;

    try {
        await db.query('DELETE FROM books WHERE book_id = ?', [bookId]);
        res.json({ success: true });
    } catch (err) {
        return res.status(500).json({ error: err.message });
    }
})
app.get('/employee_home.html',checkAuth,(req, res) => {
    res.sendFile(path.join(__dirname, 'templates', 'employee_home.html'));
  });
  app.get('/add-book.html',checkAuth, (req, res) => {
    res.sendFile(path.join(__dirname, 'templates', 'add-book.html'));
});

app.get('/edit-book.html',checkAuth, (req, res) => {
    res.sendFile(path.join(__dirname, 'templates', 'edit-book.html'));
});
// Ch·∫°y server
app.listen(3000, () => {
    console.log("Server ch·∫°y t·∫°i http://localhost:3000");
});
